<html>
	<head>
		<title>Chimera visualization</title>
        <link rel="stylesheet" type="text/css" href="css/styles/pages/main/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/buttons/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/textboxes/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/labels/style.css" />
		<script type="text/javascript" src="js/ThirdParty/three.min.js"></script>
        <script type="text/javascript" src="js/API/Globals.js"></script>
        <script type="text/javascript" src="js/API/Options.js"></script>
        <script type="text/javascript" src="js/API/NameList.js"></script>
        <script type="text/javascript" src="js/API/RGB.js"></script>
        <script type="text/javascript" src="js/API/Cookies.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/PageGrid.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/PositionReader.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/positionConfig.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/ComponentsInitializerProcessor.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/BuildProcessor.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/PhaseVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/FrequencyVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/DataProcessor/Inspectors/DataInspector.js"></script>
        <script type="text/javascript" src="js/DataProcessor/DataFormatedProcessor/DataFormatedProcessor.js"></script>
        <script type="text/javascript" src="js/DataProcessor/GetDataStrategies/GetDataSocketStrategy.js"></script>
        <script type="text/javascript" src="js/DataProcessor/GetDataStrategies/GetDataLocalStrategy.js"></script>
        <script type="text/javascript" src="js/VideoProcessor/VideoProcessor.js"></script>
	</head>
	<body onKeyDown="keyEvent()">
        <div id="container" class="container"></div>
        <script type="text/javascript">
            var formatedProcessor = new DataFormatedProcessor();
            var loadingSceneContainer = [NameList.LoadingLabel];
            var selectFileSceneContainer = [NameList.InformLabel, NameList.OpenFileDialog, NameList.SelectedFileName];
            var oneFrameVisualizationSceneContainer = [NameList.TimeMomentsLabel, NameList.SelectTimeMomentTextBox, NameList.BuildFrameButton, NameList.VideoButton, NameList.CutButton, NameList.OpacitySlider];
            var videoVisualizationSceneContainer = [NameList.VideoBack, NameList.VideoPause, NameList.VideoNext, NameList.VideoClose];
            var data = [];
            var initProcessor;
            var pageGrid;
            var visualizationType;
            var oscilatorsCount;
            var isDataReady;
            var buildProcessor;
            var videoProcessor = new VideoProcessor();

            function GetData()
            {
                LoadLoadingScene();
                var inspector = new DataInspector(Options.GetDataStrategy);
                inspector.GetData();

                WaitForDataReadyState(DataReadyCallback);

                visualizationType = inspector.GetType(Globals.VisualizationType);
                oscilatorsCount = inspector.GetOscillatorNumber(Globals.FilePath);

                Globals.OscillatorsNumber = oscilatorsCount;

                buildProcessor = new BuildProcessor(visualizationType);
                CloseLoadingScene();
            }

            function DataReadyCallback()
            {
                data = document.getElementById("sockerDataTransferContainer").innerText;
                data = formatedProcessor.FormatData(data);
                
                CloseLoadingScene();
                LoadOneFrameVisualizationScene();
            }

            function WaitForDataReadyState(callback) {
                setTimeout(
                   function () {
                       if (isDataReady) {
                           if (callback !== undefined) {
                               callback();
                           }

                       } else {
                           WaitForDataReadyState(callback);
                       }
                   }, 5);
            }

            function labelTextChanged() {
                isDataReady = true;
            }

            function InitBuildParameters() {
                Globals.MaxTimeFrame = (data.length - 1) / oscilatorsCount;
            }

            window.onload = function onload() {
                pageGrid = new PageGrid();
                initProcessor = new ComponentsInitializerProcessor();

                pageGrid.CreateGrid(window.innerWidth, window.innerHeight);
                CalculatePositions();

                if (Options.GetDataStrategy == "Local")
                {
                    LoadSelectFileScene();
                }
                else if (Options.GetDataStrategy == "Server")
                {
                    GetData();
                }
            };
            function LoadSelectFileScene() {
                initProcessor.SetSceneVisibility(selectFileSceneContainer, true);
            }

            function CloseSelectFileScene() {
                initProcessor.SetSceneVisibility(selectFileSceneContainer, false);
            }

            //file:///D:/Chimera/chimera_visualization/src/html/main.html?type=F&fileName=/root/gleb/data/trajectory2.xz

            function LoadOneFrameVisualizationScene() {
                initProcessor.SetSceneVisibility(oneFrameVisualizationSceneContainer, true);
            }

            function CloseOneFrameVisualizationScene() {
                initProcessor.SetSceneVisibility(oneFrameVisualizationSceneContainer, false);
            }

            function LoadVideoVisualizationScene() {
                initProcessor.SetSceneVisibility(videoVisualizationSceneContainer, true);
            }

            function CloseVideoVisualizationScene() {
                initProcessor.SetSceneVisibility(videoVisualizationSceneContainer, false);
            }

            function LoadLoadingScene() {
                initProcessor.SetPosition(loadingSceneContainer, pageGrid);
                initProcessor.SetSceneVisibility(loadingSceneContainer, true);
            }

            function CloseLoadingScene() {
                initProcessor.SetSceneVisibility(loadingSceneContainer, false);
            }

            function CalculatePositions()
            {
                initProcessor.SetPosition(oneFrameVisualizationSceneContainer, pageGrid);
                initProcessor.SetPosition(videoVisualizationSceneContainer, pageGrid);
            }

            function StartVisualization()
            {
                InitBuildParameters();

                var currentFrame = document.getElementById(NameList.SelectTimeMomentTextBox).value;
                buildProcessor.build(data, currentFrame);
            }

            function video() {
                InitBuildParameters();

                CloseOneFrameVisualizationScene();
                LoadVideoVisualizationScene();

                videoProcessor.init(buildProcessor);
                videoProcessor.play(data);
            }

            function videoClose() {
                CloseVideoVisualizationScene();
                LoadOneFrameVisualizationScene();

                videoProcessor.close();
            }

            function readText(that) {
            }

            function keyEvent() {
                switch (event.keyCode) {
                    case 37:
                        buildProcessor.rotate_left();
                        break;
                    case 38:
                        buildProcessor.rotate_up();
                        break;
                    case 39:
                        buildProcessor.rotate_right();
                        break;
                    case 40:
                        buildProcessor.rotate_down();
                        break;
                    case 107:
                        buildProcessor.zoom();
                        break;
                    case 109:
                        buildProcessor.unzoom();
                        break;
                    default:
                        break;
                }

            }


        </script>
        <label id="loadingLabel" style="position:absolute; visibility:hidden">Loading...Please wait...</label>
        <label id="informLabel" style="position:absolute; visibility:hidden">Data file: </label>
        <input id="openFile" type="file" style="position:absolute; visibility:hidden" onchange='readText(this)' multiple />
        <label id="selectedFileName"style="position:absolute; visibility:hidden"/>
        <input id="textLabel" type="text" style="position:absolute; visibility:hidden" class="chimeraLabel" value="Time moment:" disabled />
        <input id="time" type="text" style="position:absolute; visibility:hidden" class="chimeraTextBox" value="1" />
        <input id="build" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Build" onclick="StartVisualization()">
        <input id="video3D" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Video 3D" onclick="video()">
        <input id="videoPause" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Pause" onclick="videoPause()">
        <input id="videoNext" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Next" onclick="videoNext()">
        <input id="videoBack" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Back" onclick="videoBack()">
        <input id="videoClose" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Close" onclick="videoClose()">
        <input id="cut" type="submit" style="position:absolute; visibility:hidden" class="chimeraButton" value="Cut" onclick="parent.location = 'html/pages/cut.html'">
        <input id="opacity" type="range" style="position:absolute; visibility:hidden" min="0" max="100">
        <label id="sockerDataTransferContainer" style="display:none" onchange="labelTextChanged()"></label>

    </body>
</html>