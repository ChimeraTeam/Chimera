<html>
	<head>
		<title>Chimera visualization</title>
        <link rel="stylesheet" type="text/css" href="css/styles/pages/main/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/buttons/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/textboxes/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/labels/style.css" />
		<script type="text/javascript" src="js/ThirdParty/three.min.js"></script>
        <script type="text/javascript" src="js/API/Globals.js"></script>
        <script type="text/javascript" src="js/API/Options.js"></script>
        <script type="text/javascript" src="js/API/NameList.js"></script>
        <script type="text/javascript" src="js/API/RGB.js"></script>
        <script type="text/javascript" src="js/API/Cookies.js"></script>
        <script type="text/javascript" src="js/API/DiagnosticTools.js"></script>
        <script type="text/javascript" src="js/API/DataTransfer.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/PageGrid.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/PositionReader.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/positionConfig.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/ComponentsInitializerProcessor.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/BuildProcessor.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/PhaseVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/FrequencyVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/DataProcessor/Inspectors/DataInspector.js"></script>
        <script type="text/javascript" src="js/DataProcessor/DataFormatedProcessor/DataFormatedProcessor.js"></script>
        <script type="text/javascript" src="js/DataProcessor/GetDataStrategies/GetDataSocketStrategy.js"></script>
        <script type="text/javascript" src="js/DataProcessor/GetDataStrategies/GetDataLocalStrategy.js"></script>
        <script type="text/javascript" src="js/VideoProcessor/VideoProcessor.js"></script>
	</head>
	<body onKeyDown="keyEvent()">
        <div id="container" class="container"></div>
        <script type="text/javascript">
            var formatedProcessor = new DataFormatedProcessor();
            var loadingSceneContainer = [NameList.LoadingLabel];
            var selectFileSceneContainer = [NameList.InformLabel, NameList.OpenFileDialog, NameList.SelectedFileName];
            var oneFrameVisualizationSceneContainer = [NameList.TimeMomentsLabel, NameList.SelectTimeMomentTextBox, NameList.BuildFrameButton, NameList.VideoButton];
            var additionalFunctionalityContainer = [NameList.CutButton, NameList.OpacitySlider, NameList.OpacityLabel];
            var videoVisualizationSceneContainer = [NameList.VideoBack, NameList.VideoPause, NameList.VideoNext, NameList.VideoClose];
            var currentFrameInfoSceneContainer = [NameList.CurrentFrameLabel];
            var data = [];
            var initProcessor;
            var pageGrid;
            var visualizationType;
            var oscilatorsCount;
            var isDataReady;
            var buildProcessor;
            var videoProcessor = new VideoProcessor();
            var diagnosticTools = new DiagnosticTools();

            function GetData()
            {
                LoadLoadingScene();
                var inspector = new DataInspector(Options.GetDataStrategy);
                inspector.GetData();

                WaitForDataReadyState(DataReadyCallback);

                visualizationType = inspector.GetType(Globals.VisualizationType);
                oscilatorsCount = inspector.GetOscillatorNumber(Globals.FilePath);

                Globals.OscillatorsNumber = oscilatorsCount;

                buildProcessor = new BuildProcessor(visualizationType);
                CloseLoadingScene();
            }

            function DataReadyCallback()
            {
                data = document.getElementById("sockerDataTransferContainer").innerText;
                data = formatedProcessor.FormatData(data);
                
                CloseLoadingScene();
                LoadOneFrameVisualizationScene();
            }

            function WaitForDataReadyState(callback) {
                setTimeout(
                   function () {
                       if (isDataReady) {
                           if (callback !== undefined) {
                               callback();
                           }

                       } else {
                           WaitForDataReadyState(callback);
                       }
                   }, 50);
            }

            function labelTextChanged() {
                isDataReady = true;
            }

            window.onload = function onload() {
                pageGrid = new PageGrid();
                initProcessor = new ComponentsInitializerProcessor();

                pageGrid.CreateGrid(window.innerWidth, window.innerHeight);
                CalculatePositions();

                if (Options.GetDataStrategy == "Local")
                {
                    LoadSelectFileScene();
                }
                else if (Options.GetDataStrategy == "Server")
                {
                    GetData();
                }
            };
            function LoadSelectFileScene() {
                initProcessor.SetSceneVisibility(selectFileSceneContainer, true);
            }

            function CloseSelectFileScene() {
                initProcessor.SetSceneVisibility(selectFileSceneContainer, false);
            }

            function LoadOneFrameVisualizationScene() {
                initProcessor.SetSceneVisibility(oneFrameVisualizationSceneContainer, true);
            }

            function CloseOneFrameVisualizationScene() {
                initProcessor.SetSceneVisibility(oneFrameVisualizationSceneContainer, false);
            }

            function LoadAdditionalFunctionalityScene() {
                initProcessor.SetSceneVisibility(additionalFunctionalityContainer, true);
                document.getElementById(NameList.OpacitySlider).value = Options.DefaultOpacity;
                document.getElementById(NameList.OpacityLabel).value = 'Opacity: ' + Options.DefaultOpacity;
            }

            function CloseAdditionalFunctionalityScene() {
                initProcessor.SetSceneVisibility(additionalFunctionalityContainer, false);
            }

            function LoadVideoVisualizationScene() {
                initProcessor.SetSceneVisibility(videoVisualizationSceneContainer, true);
            }

            function CloseVideoVisualizationScene() {
                initProcessor.SetSceneVisibility(videoVisualizationSceneContainer, false);
            }

            function LoadCurrentFrameInfoScene() {
                initProcessor.SetSceneVisibility(currentFrameInfoSceneContainer, true);
            }

            function CloseCurrentFrameInfoScene() {
                initProcessor.SetSceneVisibility(currentFrameInfoSceneContainer, false);
            }

            function LoadLoadingScene() {
                initProcessor.SetPosition(loadingSceneContainer, pageGrid);
                initProcessor.SetSceneVisibility(loadingSceneContainer, true);
            }

            function CloseLoadingScene() {
                initProcessor.SetSceneVisibility(loadingSceneContainer, false);
            }

            function CalculatePositions()
            {
                initProcessor.SetPosition(oneFrameVisualizationSceneContainer, pageGrid);
                initProcessor.SetPosition(additionalFunctionalityContainer, pageGrid);
                initProcessor.SetPosition(videoVisualizationSceneContainer, pageGrid);
                initProcessor.SetPosition(currentFrameInfoSceneContainer, pageGrid);
            }

            function SetCurrentFrameValue(value)
            {
                initProcessor.SetControlValue(NameList.CurrentFrameLabel, 'Current Frame: ' + value);
            }

            function StartVisualization()
            {
                var currentFrame = document.getElementById(NameList.SelectTimeMomentTextBox).value;
                buildProcessor.build(data, currentFrame);
            }

            function video() {
                initProcessor.SetControlValue(NameList.VideoPause, "Pause");

                CloseOneFrameVisualizationScene();
                LoadVideoVisualizationScene();

                videoProcessor.init(buildProcessor);
                videoProcessor.play(data);
            }

            function videoClose() {
                CloseVideoVisualizationScene();
                LoadOneFrameVisualizationScene();
                
                videoProcessor.close();
            }

            function videoPause() {
                var value = document.getElementById(NameList.VideoPause).value;

                if (value == "Pause") {
                    videoProcessor.pause();
                    initProcessor.SetControlValue(NameList.VideoPause, "Resume");
                    initProcessor.SetDisabledButtonProperty(NameList.VideoBack, false);
                    initProcessor.SetDisabledButtonProperty(NameList.VideoNext, false);
                }
                else {
                    videoProcessor.resume();
                    initProcessor.SetControlValue(NameList.VideoPause, "Pause");
                    initProcessor.SetDisabledButtonProperty(NameList.VideoBack, true);
                    initProcessor.SetDisabledButtonProperty(NameList.VideoNext, true);
                }
            }

            function videoBack() {
                videoProcessor.back();
            }

            function videoNext() {
                videoProcessor.next();
            }

            function cut() {
                //var dataTransfer = new DataTransfer();
                //dataTransfer.SendData(buildProcessor.getCurrentFrameData());

                var win = window.open('html/pages/cut.html', '_blank');
                win.focus();
            }

            function opacityChange() {
                var value = document.getElementById(NameList.OpacitySlider).value;
                buildProcessor.updateOpacity(value);
                document.getElementById(NameList.OpacityLabel).value = 'Opacity: ' + value;
            }

            function readText(that) {
            }

            function keyEvent() {
                switch (event.keyCode) {
                    case 37:
                        buildProcessor.rotate_left();
                        break;
                    case 38:
                        buildProcessor.rotate_up();
                        break;
                    case 39:
                        buildProcessor.rotate_right();
                        break;
                    case 40:
                        buildProcessor.rotate_down();
                        break;
                    case 107:
                        buildProcessor.zoom();
                        break;
                    case 109:
                        buildProcessor.unzoom();
                        break;
                    default:
                        break;
                }

            }


        </script>
        <label id="loadingLabel" style="position:absolute; visibility:hidden">Loading...Please wait...</label>
        <label id="informLabel" style="position:absolute; visibility:hidden">Data file: </label>
        <input id="openFile" type="file" style="position:absolute; visibility:hidden" onchange='readText(this)' multiple />
        <label id="selectedFileName"style="position:absolute; visibility:hidden"/>
        <input id="textLabel" type="text" style="position:absolute; visibility:hidden" class="chimeraLabel" value="Time moment:" disabled />
        <input id="time" type="text" style="position:absolute; visibility:hidden" class="chimeraTextBox" value="1" />
        <input id="build" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Build" onclick="StartVisualization()">
        <input id="video3D" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Video 3D" onclick="video()">
        <input id="videoPause" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Pause" onclick="videoPause()">
        <input id="videoNext" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Next" onclick="videoNext()" disabled>
        <input id="videoBack" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Back" onclick="videoBack()" disabled>
        <input id="videoClose" type="button" style="position:absolute; visibility:hidden" class="chimeraButton" value="Close" onclick="videoClose()">
        <input id="currentFrame" type="text" style="position:absolute; visibility:hidden" class="chimeraLabel" value="Current Frame:" disabled />
        <input id="cut" type="submit" style="position:absolute; visibility:hidden" class="chimeraButton" value="Cut" onclick="cut()">
        <input id="opacity" type="range" style="position:absolute; visibility:hidden" min="0" step="0.01" max="1" value="0.12" onchange="opacityChange()">
        <input id="opacityLabel" type="text" style="position:absolute; visibility:hidden" class="chimeraLabel" value="Opacity" disabled />
        <label id="sockerDataTransferContainer" style="display:none" onchange="labelTextChanged()"></label>

    </body>
</html>