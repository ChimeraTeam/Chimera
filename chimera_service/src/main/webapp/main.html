<html>
	<head>
        <meta charset="UTF-8">
		<title>Chimera Visualization Service</title>
        <link rel="icon" type="image/png" href="images/chimera32x32.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="images/chimera16x16.png" sizes="16x16" />
        <link rel="stylesheet" type="text/css" href="css/styles/pages/main/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/buttons/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/checkboxes/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/textboxes/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/divs/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/labels/style.css" />
        <link rel="stylesheet" type="text/css" href="css/styles/controls/progress/style.css" />
        <script type="text/javascript" src="js/ChimeraVisualizationManager.js"></script>
        <script type="text/javascript" src="js/ThirdParty/three.js"></script>
        <script type="text/javascript" src="js/API/Cookies.js"></script>
        <script type="text/javascript" src="js/API/Colors.js"></script>
        <script type="text/javascript" src="js/Options/Globals.js"></script>
        <script type="text/javascript" src="js/Options/OptionSchema.js"></script>
        <script type="text/javascript" src="js/Options/OptionNames.js"></script>
        <script type="text/javascript" src="js/Options/Options.js"></script>
        <script type="text/javascript" src="js/Options/OptionsWindowControlNames.js"></script>
        <script type="text/javascript" src="js/Options/OptionWindowHandlers.js"></script>
        <script type="text/javascript" src="js/API/NameList.js"></script>
        <script type="text/javascript" src="js/API/ChimeraMessage.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/PageGrid.js"></script>
        <script type="text/javascript" src="js/ComponentsLoader/positionConfig.js"></script>
        <script type="text/javascript" src="js/UI/UIManager.js"></script>
        <script type="text/javascript" src="js/UI/UICreator.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/BuildProcessor.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/PhaseVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/BuildModelProcessor/Strategies/FrequencyVisualizationStrategy.js"></script>
        <script type="text/javascript" src="js/DataProcessor/SocketDataInspector.js"></script>
        <script type="text/javascript" src="js/DataProcessor/DataDecryptedService/DataDecryptedService.js"></script>
        <script type="text/javascript" src="js/VideoProcessor/VideoProcessor.js"></script>
        <script type="text/javascript" src="js/CutProcessor/CutProcessor.js"></script>
	</head>
	<body onKeyDown="keyEvent(event)" onresize="onresize()">
        <div id="container" class="container"></div>
        <script type="text/javascript">
            var chimeraData = [];
            var pageGrid;
            var visualizationType;
            var oscilatorsCount;
            var buildProcessor;
            var cutProcessor;
            var videoProcessor;
            var uiManager;
            var chimeraManager = new ChimeraVisualizationManager();
            
            function init()
            {
                var inspector = new SocketDataInspector();
                uiManager = new UIManager();
                Options.TryGetSettingsFromCookies();

                inspector.init(DataReadyCallback, uiManager.loadLoadingScene);

                visualizationType = inspector.getType(Globals.VisualizationType);
                oscilatorsCount = inspector.getOscillatorNumber(Globals.FilePath);

                Globals.OscillatorsNumber = oscilatorsCount;

                switch (oscilatorsCount) {
                    case Globals.MediumOsillatorsCount:
                        Options.SetValue(OptionNames.CameraPosition, Globals.CameraPositionMedium);
                        break;
                    case Globals.LargeOsillatorsCount:
                        Options.SetValue(OptionNames.CameraPosition, Globals.CameraPositionLarge);
                        break;
                    default:
                        break;
                }

                buildProcessor = new BuildProcessor(visualizationType);
            }

            function DataReadyCallback()
            {
                if (Options.GetBoolValue(OptionNames.WaitAllFrames)) {
                    var dataDecryptService = new DataDecryptedService();
                    var container = document.getElementById("sockerDataTransferContainer");

                    chimeraData = dataDecryptService.decryptData(container.innerHTML);

                    uiManager.closeLoadingScene();
                }

                uiManager.loadOneFrameVisualizationScene();
            }

            window.onload = function onload() {
                init();

                pageGrid = new PageGrid();

                pageGrid.createGrid(window.innerWidth, window.innerHeight);
                uiManager.calculatePositions(pageGrid);
            };

            function onresize() {
                pageGrid.createGrid(window.innerWidth, window.innerHeight);
                uiManager.calculatePositions(pageGrid);
            }
            
            window.onoffline = function () {
                ChimeraMessage.ShowMessage(ChimeraMessage.Warning, ChimeraMessage.OnOfflineWarning);
            }

            window.onunload = function () {
                if (Options.GetBoolValue(OptionNames.NeedSaveSettingsToCookies)) {
                    Options.Save();
                } else {
                    Options.CleanCookies();
                }
            }

            function keyEvent(event) {
                switch (event.keyCode) {
                    case 37:
                        buildProcessor.rotate_left();
                        break;
                    case 38:
                        buildProcessor.rotate_up();
                        break;
                    case 39:
                        buildProcessor.rotate_right();
                        break;
                    case 40:
                        buildProcessor.rotate_down();
                        break;
                    case 107:
                        buildProcessor.zoom();
                        break;
                    case 109:
                        buildProcessor.unzoom();
                        break;
                    case 27:
                        if (cutProcessor != null) {
                            uiManager.getUICreator().setControlValue(NameList.CurrentCutTypeLabel, 'Current Cut type: none');
                            cutProcessor.exit();
                        }
                        break;
                    default:
                        break;
                }

            }

        </script>
        
        <progress id="loadingProgressBar" class="chimeraProgressBar" max="100" value="0"></progress>
        <input id="loadingLabel" type="text" class="chimeraProgressLabel" value="Loading...Please wait..." disabled/>
        <input id="textLabel" type="text" class="chimeraLabel" value="Time moment:" disabled />
        <input id="time" type="text" style="position:absolute; visibility:hidden" class="chimeraTextBox" value="1" />
        <input id="build" type="button" class="chimeraButton" value="Build" onclick="chimeraManager.startVisualization()">
        <input id="video3D" type="button" class="chimeraButton" value="Video 3D" onclick="chimeraManager.playVideo()">
        <input id="videoPause" type="button" class="chimeraButton" value="Pause" onclick="chimeraManager.videoPause()">
        <input id="videoNext" type="button" class="chimeraButton" value="Next" onclick="chimeraManager.videoNext()" disabled>
        <input id="videoBack" type="button" class="chimeraButton" value="Back" onclick="chimeraManager.videoBack()" disabled>
        <input id="videoClose" type="button"class="chimeraButton" value="Close" onclick="chimeraManager.videoClose()">
        <input id="currentFrame" type="text" class="chimeraLabel" value="Current Frame:" disabled />
        <input id="cut" type="submit" class="chimeraButton" value="Cut" onclick="chimeraManager.cut()">
        <input id="horizontalCut" type="button" class="chimeraButton" value="H" onclick="chimeraManager.horizontalCut()"/>
        <input id="verticalCut" type="button" class="chimeraButton" value="V" onclick="chimeraManager.verticalCut()"/>
        <input id="currentCutType" type="text" class="chimeraLabel" value="Current Cut type: none" disabled />
        <input id="closeCut" type="button" class="chimeraButton" value="Exit from the Cut mode" onclick="chimeraManager.closeCut()" />
        <input id="opacity" type="range" style="position:absolute; visibility:hidden" min="0" step="0.01" max="1" value="0.12" onchange="chimeraManager.onOpacityChanged()">
        <input id="opacityLabel" type="text" class="chimeraLabel" value="Opacity" disabled />
        <input id="pointSize" type="range" style="position:absolute; visibility:hidden" min="0.5" step="0.1" max="10" value="3.5" onchange="chimeraManager.onPointSizeChanged()">
        <input id="pointSizeLabel" type="text" class="chimeraLabel" value="Particle Size" disabled />
        <input id="reset" type="button" class="chimeraButton" value="Reset" onclick="chimeraManager.reset()"/>
        <label id="sockerDataTransferContainer" style="display:none" onchange="chimeraManager.onDataChanged()"></label>
        <input id="changeSettingsButton" type="button" class="chimeraCircleButton" value="=" onclick="chimeraManager.changeSettings()"/>
        <input id="aboutButton" type="button" class="chimeraCircleButton" value="?" onclick="chimeraManager.about()"/>
        <div id="optionsContainer" class="chimeraDiv">
            <br>
            <label style="padding-left: 10%; font-size: 2vw">Default Settings</label>
            <br><br>
            <input id="opacityOptionLabel" type="text" class="chimeraSettingsLabel" value="Opacity:"/>
            <input id="opacityOptionTextBox" type="text" class="chimeraSettingsTextBox"/>
            <br><br>
            <input id="pointSizeOptionLabel" type="text" class="chimeraSettingsLabel" value="PointSize:"/>
            <input id="pointSizeOptionTextBox" type="text" class="chimeraSettingsTextBox"/>
            <br><br>
            <input id="videoDelayOptionLabel" type="text" class="chimeraSettingsLabel" value="Video Delay, ms:"/>
            <input id="videoDelayOptionTextBox" type="text" class="chimeraSettingsTextBox"/>
            <br><br>
            <input id="autoResetRotationZoomLabel" type="text" class="chimeraSettingsLabel" value="Auto-Reset Rotation:"/>
            <input id="autoResetRotationZoomCheckBox" type="checkbox" class="chimeraSettingsCheckbox"/>
            <br><br>
            <input id="saveCookiesButton" type="text" class="chimeraSettingsLabel" value="Using cookies:"/>
            <input id="saveCookiesCheckBox" type="checkbox" class="chimeraSettingsCheckbox" onclick="chimeraManager.onSaveCookieCheckBoxClicked()"/>
            <br><br>
            <input id="waitAllFramesButton" type="text" class="chimeraSettingsLabel" value="Wait All Frames:"/>
            <input id="waitAllFramesCheckBox" type="checkbox" class="chimeraSettingsCheckbox" onclick="chimeraManager.onWaitAllFramesCheckBoxClicked()"/>
            <br><br><br><br><br><br><br><br><br><br>
            <input id="applySettingsButtons" type="button" class="chimeraSettingsButton" value="Apply" onclick="chimeraManager.applySettings()"/>
            <br><br>
            <input id="cancelSettingsButtons" type="button" class="chimeraSettingsButton" value="Cancel" onclick="chimeraManager.changeSettings()"/>
        </div>
    </body>
</html>